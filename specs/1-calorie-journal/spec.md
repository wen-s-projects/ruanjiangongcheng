# Feature Specification: 卡路里日记（Calorie Journal）

**Feature Branch**: `1-calorie-journal`
**Created**: 2026-01-04
**Status**: Draft
**Input**: User description: "构建一个简单的双端卡路里记录系统，包含文章发布(Markdown 支持)、标签分类、评论功能"

## User Scenarios & Testing *(mandatory)*

### 用户场景概览
- 用户可以发布文章（支持 Markdown），以记录饮食经验、卡路里分析或心得；文章支持标签分类、评论与搜索。 (P1)
- 用户可以浏览文章列表、按标签筛选文章并查看单篇文章的渲染内容和评论。 (P1)
- 用户可以对文章发表评论并回复评论；支持基本的反垃圾/长度限制与显示顺序。 (P1)
- 用户可以在个人页查看其发表的文章与卡路里记录（卡路里日志/条目为补充功能）。 (P2)

---

### User Story - 用户发布文章 (Priority: P1)
**简述**: 作为一名注册用户，我希望能创建并发布包含 Markdown 内容的文章、为其添加一个或多个标签，并实时预览渲染效果，以便与其他用户分享我的饮食记录与卡路里分析。

**为何重要**: 文章功能是平台内容生成的核心，支持用户生成高质量内容并促进社区互动（评论/标签），增强留存与共享。

**独立测试**: 在隔离环境中，使用已登录账号：创建文章，填写标题与 Markdown 内容，选择或创建标签，点击“发布”，然后验证文章在列表页、详情页显示、标签可点击并正确过滤、评论框显示并可提交评论。

**验收场景 / Acceptance Scenarios**:

1. **发布成功**
   - 给定：用户已登录并在“新建文章”页面
   - 当：填写标题（非空）、Markdown 内容（可以包含标题、段落、图片链接、代码块）、选择或新增至少一个标签并点击“发布”
   - 则：系统将文章保存为已发布状态；用户被重定向到文章详情页；页面显示由 Markdown 渲染后的 HTML 内容；页面同时显示文章的标签和作者信息

2. **内容校验**
   - 给定：用户提交表单
   - 当：标题为空或 Markdown 内容为空
   - 则：系统返回表单验证错误并在相应字段显示可理解的错误消息（例如："标题为必填项"）且不创建文章

3. **标签管理**
   - 给定：标签列表存在若干标签
   - 当：用户在新建文章时输入新的标签名并提交
   - 则：系统创建新的标签并与文章关联；标签名须去重（大小写不敏感）且长度限制（例如 1-30 字符）被强制执行

4. **渲染与安全**
   - 给定：文章 Markdown 含 HTML 或脚本注入尝试
   - 当：系统渲染 Markdown
   - 则：渲染后的输出应对潜在的 XSS 做到恰当的清理/转义（禁止执行脚本），但允许常见 Markdown 元素（如图片、代码块、表格）

5. **权限与访问控制**
   - 给定：未登录用户试图访问“发布文章”功能
   - 当：用户尝试保存或访问创建页面
   - 则：系统应重定向到登录页或返回 401/403（取决于客户端约定），禁止匿名发布

6. **编辑与删除（基本）**
   - 给定：作者访问自己已发布的文章
   - 当：作者选择“编辑”并提交变更，或选择“删除”并确认
   - 则：系统允许作者编辑/删除其文章；删除需有确认步骤并在详情页不再显示已删除文章

7. **评论开关**
   - 给定：文章详情页
   - 当：文章被发布时，默认启用评论（可在创建/编辑时选择关闭）
   - 则：若启用，任何已登录用户可提交评论；若禁用，评论区隐藏或显示为“评论已关闭”提示

---

### Edge Cases
- 超大文章（> 50,000 字）应受限并提示合适错误信息
- Markdown 中的远程图片加载失败时，页面应优雅降级显示占位图或替代文本
- 标签名冲突和特殊字符处理（仅允许字母、数字、空格、连字符和下划线）

## Requirements *(mandatory)*

### Functional Requirements
- **FR-001**: 系统 MUST 允许已注册用户创建文章，包含字段：标题（必填）、Markdown 正文（必填）、标签（可选）、是否允许评论（布尔）
- **FR-002**: 系统 MUST 将 Markdown 内容转换为安全的渲染 HTML 并防止 XSS 注入
- **FR-003**: 系统 MUST 支持标签的创建、唯一性检查与关联查询（按标签过滤文章）
- **FR-004**: 系统 MUST 允许已登录用户对文章发表评论，评论包括：作者、内容、时间戳
- **FR-005**: 系统 MUST 在文章详情页显示评论列表并支持分页（或懒加载）以防页面过长
- **FR-006**: 系统 MUST 验证并限制输入长度（标题 ≤ 200 字符，正文上限 50,000 字符，评论 ≤ 2000 字符，标签 1-30 字符）
- **FR-007**: 系统 MUST 在无法渲染或出错时返回友好错误并保持用户内容不丢失（使用草稿或回退机制）
- **FR-008**: 系统 MUST 记录审计日志（文章创建、编辑、删除、评论操作）以便后续追踪

### Non-functional Requirements
- **NFR-001**: 新发布文章在 5 秒内在文章列表/详情页可见
- **NFR-002**: 平台应支持同时 100 并发读取请求（基线目标），并在负载高时按优先级保证关键读路径
- **NFR-003**: 所有用户可见页面的首次内容渲染应在 2 秒内完成（在正常网络下）

## Key Entities
- **User**: id, 昵称, email, 头像（可选）, 注册日期
- **Article**: id, 作者(User), 标题, Markdown 内容, 渲染 HTML, 状态 (draft/published), 标签列表, 是否允许评论, 创建/修改时间
- **Tag**: id, 名称, 文章计数
- **Comment**: id, 文章(Article), 作者(User), 内容, 创建时间, 状态 (active/hidden)
- **CalorieEntry** (可选扩展): id, 用户(User), 食物名, 卡路里, 日期时间, 描述

## Success Criteria *(mandatory)*
- **SC-001**: 90% 的用户能在 3 分钟内成功发布一篇包含标题、正文与至少一个标签的文章
- **SC-002**: 已发布文章在详情页正确渲染 Markdown 的常见元素（标题、列表、图片、代码块）且无 XSS 漏洞（通过自动化安全扫描验证）
- **SC-003**: 标签过滤功能在 95% 的查询中返回结果在 1 秒内（基线目标）
- **SC-004**: 评论发送成功率 ≥ 99%（正常网络条件下）

## Assumptions
- 仅**已注册并登录**用户可发布文章与评论；匿名用户仅可阅读公开文章
- Markdown 中允许外部图片链接，图片加载问题由客户端优雅处理（不阻塞文章展示）
- 默认启用评论，站点管理员可全局或针对某篇文章关闭评论

---

## Platforms, Integration & UI Alignment
- **平台**: 本功能应覆盖：
  - Web 网页端（Windows 优先，但支持主流桌面浏览器），用于完整管理、文章浏览与管理员审核；
  - 安卓 App：提供核心阅读、创建（通过移动端相机/图库）和评论功能；
  - 管理端（Admin Web）：仅网页端可访问，用于审核用户上传的食材/内容和管理文章。
- **UI 对齐（Design/Prototypes）**:
  - 主页采用左右分栏（左侧：日历历史记录；右上：身体数据汇总；右下：AI 交互），文章列表与详情页风格应与 `Design/Prototypes/网页主页.jpg`、`历史记录的详细页面.jpg` 和 `今日卡路里详情页面.gif` 保持一致；移动端应遵循 `手机端主要页面.jpg` 的模块化卡片设计与底部导航记录入口。
  - 日历视图应在日期单元显示当日记录次数，点击进入显示当日明细并能从日历跳转到相关文章或摄入详情。
- **与 SRS 中的 AI/食物记录的集成点**:
  - 文章可以引用或嵌入与食物相关的条目或图片（例如：在文章中插入某次摄入记录的图片或链接 FoodDict 条目），若外部 AI 识别生成了食物条目，文章应能引用该条目的只读元数据（如食物名、热量、图片）。
  - 当 AI 识别未命中食物字典时，系统允许创建“未知食物”的占位条目，文章可嵌入占位条目的信息（热量为空或为 0，并在页面提醒“热量待补全”）。
- **数据一致性与设计契约**:
  - Article 与 FoodRecord/CalorieEntry 的关联关系应在数据模型层保持可选的参照关系：Article 可包含多个外部引用（FoodRecord id 列表或 FoodDict id 列表），但不强制依赖。
  - 管理端审核流程（针对上传/新增食材）应影响 FoodDict，而非直接变更已发布文章的内容（若需要更新文章中引用的食物信息，需通过额外的编辑流程）。

---

## Technology Notes (constraints & references)
- 实现应遵循项目宪法中规定的技术与部署约束（例如关于前端/后端/数据库的选择与 `.env` 管理）。详见：`.specify/memory/constitution.md`。
- 本规范保持以“是什么”为主，避免包含实现细节；如需例外，请在实现文档中详细说明。

---

## Tests (examples)
- 单元测试：文章模型与标签模型的创建/更新/删除用例；Markdown 渲染与 XSS 防护单元测试
- 集成测试：完整创建文章 → 列表可见 → 详情页渲染正确 → 添加评论 → 评论出现在详情页
- E2E：模拟用户登录、填写 Markdown、发布并断言最终页面显示（包括标签、作者、渲染内容）


---

**Next**: 若你确认，我将根据本 `spec.md` 生成 `tasks.md` 与初步 implementation plan（`plan.md`），并创建对应的 issue / task 列表。